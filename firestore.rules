rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Regla 1: Super Admin
    match /{document=**} {
      allow read, write: if request.auth.token.superadmin == true;
    }

    // Regla 2: Datos Públicos de Estudios (CORREGIDA Y FINAL)
    // Cualquiera puede leer la lista de estudios y documentos individuales.
    match /studios_public/{studioId} {
      allow get, list: if true;
    }

    // Regla 3: Perfiles de Usuario
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId;
    }
    
    // Regla 4: Membresías de Estudio
    match /studio_members/{membershipId} {
      allow read: if request.auth.uid != null && request.auth.uid == resource.data.userId;
    }

    // Regla 5: Datos Privados del Estudio
    match /studios/{studioId}/{document=**} {
      allow read, write: if exists(/databases/$(database)/documents/studio_members/$(request.auth.uid + '_' + studioId));
    }
  }
}
